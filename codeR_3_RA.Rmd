
---
title: "tubes pemstok"
author: "Kemas Veriandra Ramadhan"
date: "2025-11-18"
output:
  pdf_document: default
  html_document: default
---

```{r}
# 1. Load & urutkan data

data <- read.csv("data_pemstok.csv", stringsAsFactors = FALSE)
colnames(data) <- c("tanggal", "waktu", "hari_ke", "jumlah_orang", "keterangan")

# Gabungkan tanggal + waktu
data$datetime <- paste(data$tanggal, data$waktu)
data$datetime <- as.POSIXct(data$datetime, format = "%m-%d-%Y %H:%M")

# Sort berdasarkan hari_ke dan datetime
data <- data[order(data$hari_ke, data$datetime), ]
```
```{r}
data
```

```{r}
# 2. Buat state pakai quantile (3 state)
# hitung batas quantile
q <- quantile(data$jumlah_orang,
              probs = c(0, 1/3, 2/3, 1),
              na.rm = TRUE)

# mapping jumlah_orang -> state: Sepi / Sedang / Ramai
data$keterangan <- cut(
  data$jumlah_orang,
  breaks = q,
  include.lowest = TRUE,
  labels = c("Sepi", "Sedang", "Ramai")
)

# lihat ringkasan state
table(data$keterangan)
```
```{r}
q
```

```{r}
data
```

```{r}
# grafik jumlah orang per waaktu tanpa keterangan 
# tambahkan titk tiap data point
library(ggplot2)
ggplot(data, aes(x = datetime, y = jumlah_orang)) +
  geom_line(color = "blue") +
  geom_point( size = 2) +
  labs(
    title = "Jumlah Pengunjung Embung pada Setiap Waktu",
    x = "Waktu",
    y = "Jumlah Pengunjung",
    color = "Keterangan"
  ) +
  theme_minimal()
```

State didefinisikan berdasarkan kategori tingkat keramaian. Pembagian dilakukan menggunakan quantile (tertile) agar setiap kategori memiliki jumlah data yang sama. Batas quantile:

| State         | Rentang Jumlah Orang | Arti               |
|---------------|----------------------|--------------------|
| **1. Sepi**   | 12 – 34 orang        | Pengunjung sedikit |
| **2. Sedang** | 35 – 54 orang        | Keramaian normal   |
| **3. Ramai**  | 55 – 71 orang        | Pengunjung padat   |

Setiap state berisi 6 observasi.

Ruang keadaan formal:

S={1 (Sepi), 2 (Sedang), 3 (Ramai)}

```{r}
# 3. Susun rantai Markov (transisi antar state)
state_seq <- data$keterangan
# pasangan (state_t, state_{t+1})
trans_counts <- table(
  saat_ini = head(state_seq, -1),
  selanjutnya   = tail(state_seq, -1)
)
# matriks probabilitas transisi (per baris = dari suatu state)
trans_prob <- prop.table(trans_counts, 1)

cat("Batas Quantile (Sepi/Sedang/Ramai)")
print(q)

cat("Frekuensi Transisi")
print(trans_counts)

cat("Matriks Probabilitas Transisi (P)")
print(round(trans_prob, 3))

```

| Dari → Ke  | Sepi | Sedang | Ramai |
|------------|------|--------|-------|
| **Sepi**   | 3    | 1      | 1     |
| **Sedang** | 1    | 3      | 2     |
| **Ramai**  | 2    | 1      | 3     |

Dari “Sepi”, 3 kali tetap Sepi dan masing-masing 1 kali naik ke Sedang/Ramai.

Dari “Sedang”, 3 kali tetap, 2 kali naik jadi Ramai.

Dari “Ramai”, 3 kali tetap, dan cukup sering turun (2 kali ke Sepi).

```{r}
library(ggplot2)

df_trans <- as.data.frame(trans_prob)
colnames(df_trans) <- c("from", "to", "prob")

ggplot(df_trans, aes(x = from, y = to, fill = prob)) +
  geom_tile() +
  geom_text(aes(label = round(prob, 2))) +
  scale_fill_gradient(low = "white", high = "steelblue") +
  labs(
    title = "Matriks Probabilitas Transisi State Pengunjung",
    x = "State saat ini",
    y = "State berikutnya",
    fill = "Probabilitas"
  )
```

Jika SEKARANG Sepi

-   60% tetap sepI
-   20% naik ke Sedang
-   20% naik ke Ramai

Jika SEKARANG Sedang

-   16.7% turun

-   50% tetap

-   33.3% naik

Jika SEKARANG Ramai

-   33.3% turun ke Sepi

-   16.7% turun ke Sedang

-   50% tetap Ramai

State Sepi dan Ramai relatif stabil; sementara Sedang lebih “labil”.

```{r}
# install.packages("igraph")    # kalau belum ada
library(igraph)

# ubah ke matriks numeric untuk igraph
matP <- as.matrix(trans_prob)

g <- graph_from_adjacency_matrix(matP,
                                 mode = "directed",
                                 weighted = TRUE)

plot(
  g,
  edge.label = round(E(g)$weight, 3),
  vertex.size = 40,
  vertex.label.cex = 1.1,
  edge.arrow.size = 1,
  main = "Diagram Transisi Rantai Markov\nState Jumlah Pengunjung"
)
```

```{r}
#Probabilitas Langkah Ke N
P <- as.matrix(trans_prob)

# contoh 2 langkah ke depan (20 menit)
P2 <- P %*% P

# umum: n langkah ke depan
library(expm)
n <- 2
Pn <- P %^% n
Pn
```

Jika saat ini Sedang, 2 langkah ke depan (20 menit):

-   25.6% Sepi

-   33.3% tetap

-   41.1% menjadi Ramai

```{r}
#Distribusi Stasioner
P <- as.matrix(trans_prob)

eig <- eigen(t(P))
pi  <- Re(eig$vectors[,1])
pi  <- pi / sum(pi)
round(pi, 3)
```

Artinya dalam jangka waktu sangat panjang:

-   39% waktu Embung dalam kondisi Sepi

-   27% waktu dalam kondisi Sedang

-   34% waktu dalam kondisi Ramai

Klasifikasi State

-   Semua peluang antar state \> 0

-   Semua state saling terhubung (communicating)

-   Tidak ada siklus tetap → aperiodik

-   State bersifat recurrent positif

